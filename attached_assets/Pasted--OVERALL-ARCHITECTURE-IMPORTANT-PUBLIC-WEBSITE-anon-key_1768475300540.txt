# ðŸ§  OVERALL ARCHITECTURE (IMPORTANT)

```
PUBLIC WEBSITE (anon key)
        |
        v
Supabase (SELECT only)

CMS (admin panel) â†’ LOGIN REQUIRED
        |
        v
Backend API (service_role key)
        |
        v
Supabase (INSERT / UPDATE / DELETE)
```

---

# STEP 1ï¸âƒ£ Enable Supabase Auth (Email login)

Supabase Dashboard â†’ **Authentication â†’ Providers**

Turn ON:

* âœ… Email
* (Disable others for now)

Save.

---

# STEP 2ï¸âƒ£ Create editor/admin users

Supabase Dashboard â†’ **Authentication â†’ Users**

âž¡ Click **Add user**

* Email: your email
* Password: strong password

This user can now log in to CMS.

---

# STEP 3ï¸âƒ£ CMS login page (Frontend)

### Example: `cms-login.js`

```js
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_ANON_KEY
);

async function login(email, password) {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password
  });

  if (error) {
    alert(error.message);
    return;
  }

  window.location.href = '/cms';
}
```

âœ” Uses **anon key**
âœ” Safe
âœ” Auth handled by Supabase

---

# STEP 4ï¸âƒ£ Protect the CMS (block public access)

### On CMS page load

```js
const {
  data: { user }
} = await supabase.auth.getUser();

if (!user) {
  window.location.href = '/cms-login';
}
```

ðŸš« Visitors cannot access CMS without login

---

# STEP 5ï¸âƒ£ Backend API for writing (IMPORTANT)

### âŒ Never insert directly from frontend

### âœ… Always go through backend

#### `server/supabaseAdmin.js`

```js
import { createClient } from '@supabase/supabase-js';

export const supabaseAdmin = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);
```

---

### `server/publishArticle.js`

```js
import { supabaseAdmin } from './supabaseAdmin.js';

export async function publishArticle(req, res) {
  const {
    title,
    slug,
    summary,
    content,
    category_id,
    image_url
  } = req.body;

  const { error } = await supabaseAdmin
    .from('articles')
    .insert({
      title,
      slug,
      summary,
      content,
      category_id,
      image_url
    });

  if (error) {
    return res.status(500).json({ error: error.message });
  }

  res.json({ success: true });
}
```

âœ” Uses service role
âœ” Bypasses RLS
âœ” Secure

---

# STEP 6ï¸âƒ£ Call backend from CMS

### CMS frontend

```js
await fetch('/api/publish-article', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(formData)
});
```

---

# STEP 7ï¸âƒ£ RLS policies (simple & correct)

### Public reads

```sql
create policy "Public read articles"
on articles
for select
using (true);
```

### Optional safety (even though service role bypasses)

```sql
create policy "Authenticated insert articles"
on articles
for insert
with check (auth.role() = 'authenticated');
```

---

# ðŸ” WHY THIS WORKS PERFECTLY

| Problem            | Solved    |
| ------------------ | --------- |
| CMS open to public | âŒ blocked |
| RLS errors         | âŒ gone    |
| Anon insert issues | âŒ gone    |
| Security warnings  | âœ… minimal |
| Scales to editors  | âœ… yes     |

---

# âš ï¸ CRITICAL SECURITY RULES

* Never expose `SERVICE_ROLE_KEY`
* Always write via backend
* Keep anon key read-only
* CMS must require login

---

# ðŸ§  SIMPLE RULE TO REMEMBER

> **Frontend reads â†’ anon key**
> **CMS writes â†’ backend + service role**

---